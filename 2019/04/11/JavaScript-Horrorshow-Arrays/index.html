<!DOCTYPE html>
<html lang="en-GB">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>JavaScript Horrorshow: Arrays</title>
  <meta name="description" content="An Education JavaScript is a weird language. Since apparently I now write it professionally, I’ve spent the last little while trying to tease out its grisly secrets and understand them. Because by design, it is fundamentally different to almost all popular languages, it might be valuable to explore these “pleasant surprises” and try to reason about some of the insanity that is JavaScript. With that in mind, I figured that a small series of short posts on some of the most “how much can I break the JavaScript?”, “Why on earth does the grammar permit this?” moments and have a bit of a collective point and laugh as well as promising never to do any of these naughty things. With this all said and done please enjoy our first installment on Arrays.">
  
    
    <meta name="keywords" content="JavaScript, Array, Object, Grammar, Best Practice, Function, Method">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/2019/04/11/JavaScript-Horrorshow-Arrays/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Andrew McLean" href="/feed.xml">

  

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="JavaScript Horrorshow: Arrays">
  <meta name="twitter:description" content="An Education JavaScript is a weird language. Since apparently I now write it professionally, I’ve spent the last little while trying to tease out its grisly secrets and understand them. Because by ...">
  
  

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700" rel="stylesheet">

  
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-138248321-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Andrew McLean</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">JavaScript Horrorshow: Arrays</h1>
    
    <p class="post-meta"><time datetime="2019-04-11T00:00:00+00:00" itemprop="datePublished">Apr 11, 2019</time> •
  
    
    
  



</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="an-education">An Education</h2>
<p>JavaScript is a weird language. Since apparently I now write it professionally, I’ve spent the last little while trying to tease out its grisly secrets and understand them. Because by design, it is fundamentally different to almost all popular languages, it might be valuable to explore these “pleasant surprises” and try to reason about some of the insanity that is JavaScript. With that in mind, I figured that a small series of short posts on some of the most “how much can I break the JavaScript?”, “Why on earth does the grammar permit this?” moments and have a bit of a collective point and laugh as well as promising never to do any of these naughty things. With this all said and done please enjoy our first installment on Arrays.</p>

<h2 id="arrays">Arrays</h2>
<p>What is an Array? If you’ve come from the land of stack pointers and registers, you’d tell me “it’s typically a one-dimensional data structure that contains some fixed-size collection of elements in sequential order”. I’ve fallen asleep. If you’ve come from the land of applicative functors and monoids then you’d tell me “well it’s just sort of a function whose domain is isomorphic to contiguous subsets of the integers”. Now my brain has exploded. Lastly, we have JavaScript, tell me JavaScript what is an array? It’s an Object.</p>

<h3 id="a-what">A What?</h3>
<p>Yes, that’s right. “An Object”. As with all non-fundamental types – things that are not numbers, strings, etc. – at the heart of it, Arrays are just Objects. This means you can do all the things you could do to an Object, to an Array. For example, my Array is sad that it doesn’t have a name?</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">sadArray</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="nx">sadArray</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">"Dave"</span>
</code></pre></div></div>
<p>Well bam, now Dave has a name. You really can do all sorts of crazy things with Objects and almost all of them apply to Arrays too. But that’s pretty boring. I’m sure you’ve seen plenty of weird things like this before, whether it was memoizing a recursive function by giving it a property which holds a results cache or you’ve already personally been naming Arrays like it’s your life mission. That’s not what we come to see. That’s not <em>JavaScript</em> enough.</p>

<h3 id="a-what-1">A WHAT?</h3>
<p>So if an Array is an Object, can an Object be an Array? Why yes of course, why not?</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">myArray</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nx">myArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="s2">"YAY"</span>
</code></pre></div></div>
<p>Ok, let’s not get too excited, it’s just using an integer key to map to a value. We have to use the square bracket notation as <code class="highlighter-rouge">myArray.1</code> is not valid in the grammar since 1 is an Integer literal and not a valid identifier. Meh boring, let’s get weirder!</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">watArray</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nx">watArray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="s2">"I'm on the wrong side of the real line"</span>
<span class="nx">watArray</span><span class="p">[</span><span class="mf">5.434</span><span class="p">]</span><span class="o">=</span><span class="s2">"I'm definitely not an integer index"</span>
</code></pre></div></div>
<p>So like before, any number literal appears to be a suitable property key for an Object. As per the grammar, any String or Symbol type can be a key to an Object property. But Numbers aren’t any of those!? Do not fear young one, since a key has to be one of those types, when you assign a new property to an Object, if the key is not already a String or Symbol, the runtime will call ToString on your key and store the transformed String value. <a href="https://www.ecma-international.org/ecma-262/9.0/index.html#sec-tostring">ToString</a> is one of the many builtin type conversions done quite very opaquely by JavaScript, literally all the time, everywhere. As you can see if you look at the grammar, there are lots of types that have default conversions, including Numbers<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>. This is exactly why you can do the madness above, it’s completely legal and required by the grammar.</p>

<h3 id="the-apex-of-array-weirdness">The Apex of Array Weirdness</h3>
<p>Ok, that’s still not too interesting. My Arrays in JavaScript can <em>do</em> things, they have methods to do functional things like map, filter, reduce and normal things like push, pop, shift and unshift. These methods are inherited from the Array.prototype which defines all these. We could call these methods using the <code class="highlighter-rouge">myArray.method()</code> notation, i.e. a Member Expression, or we could be weird and slightly broken. Weird and slightly broken it is, i.e. <code class="highlighter-rouge">Array.prototype.method.call()</code>. This calls the method on a <code class="highlighter-rouge">this</code> and some arguments<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>. Turns out Array.prototype’s methods don’t check the <code class="highlighter-rouge">this</code> value before doing all its magic. It has to coerce the <code class="highlighter-rouge">this</code>to an Object but that is a fundamentally satisfied aside from when <code class="highlighter-rouge">this</code> is <code class="highlighter-rouge">Null</code> or <code class="highlighter-rouge">Undefined</code>. When we use <code class="highlighter-rouge">Function.prototype.call</code>, <code class="highlighter-rouge">this</code> is set to the first argument. So this means we can do the following,</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">waaat</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">waaat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>
<p>Go on, try it! You’ll see that <code class="highlighter-rouge">waaat</code> is now <code class="highlighter-rouge">{0:1, length:1}</code>. Ok, so this is super weird. SUPER WEIRD, love it. You can keep playing calling your Array.prototype methods on your <del>Object</del> array, sorry. If you keep <code class="highlighter-rouge">push</code>ing on your array, the length will continue to increment and behave all array-like. Now try reassigning length to a lower value,</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">arr</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="s2">"WAT"</span><span class="p">)</span>
</code></pre></div></div>
<p>Yep, it’ll just write into where it thinks there is space. What, you didn’t think calling builtin Array methods on a not Array could go wrong? Well it will. This is a very, very silly idea. Next, try making length too long,</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">arr</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">4</span>
<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="s2">"WAT"</span><span class="p">)</span>
</code></pre></div></div>
<p>Ooo! It doesn’t pad the array like actual Arrays. How convenient. The length is totally wrong now though, oh well.</p>

<p>Wow, at this point I think we’ve had enough weirdness to make even a JavaScript maestro sweat a little. That should probably do for today.</p>

<p>Despite all this dreadfulness, Arrays are very useful in JavaScript, allowing you to implement a more declarative style using methods like map and also add collection semantics to your code – i.e. I can have and do stuff to a list of things, not just one thing – both of these features facilitating the authoring of expressive, useful code. Everything we have seen today is an absolute defamation of these lovely things. Please, if you ever find yourself writing anything at all like that seen above, you are doing it wrong. Let the emotions of this whirlwind tour through JavaScript weird settle into a resolve never to do things as silly as this anywhere near production and be thankful that Arrays are considered Exotic Objects that do exotic things and we get all of this magic functionality in complete correctness for free. That is to say, don’t forget to be nice to your Arrays. They’re fantastic Objects!</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>As you might have seen, that also includes Objects! To make a String from an Object requires calling the ToPrimitive conversion with a String hint. This delegates to the <code class="highlighter-rouge">toString</code> and <code class="highlighter-rouge">valueOf</code> methods of your object if they exist and in that explicit order. So make sure to implement <code class="highlighter-rouge">toString</code> methods for your objects and you can almost have a real map! <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>This also displays some funky JavaScript inheritance. Array’s prototype has methods, these are all hard coded and not rewritable. Since the methods also are Function Objects, they inherit the Function.prototype which gives the call method. For example, <code class="highlighter-rouge">myArray = [1,2,3]; myArray.map.call()</code>, finds map in the Array.prototype property and then finds call in the prototype of that method, being the Function.prototype. What a wacky language. <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy;  - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
